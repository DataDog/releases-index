{
  "Content": "# cf-mysql-release v34\r\n\r\nHey! We're thinking of dropping `spiff` manifest templates in favor of using BOSH's native features.\r\n- Is this OK? Click: [:green_heart:](http://clickpoint.cfapps.io/click/mysql-manifest-gen?lose-spiff)\r\n- Is disaster? Click: [:broken_heart:](http://clickpoint.cfapps.io/click/mysql-manifest-gen?keep-spiff)\r\n\r\nTo see more, check out our work in progress, [cf-mysql-deployment](https://github.com/cloudfoundry/cf-mysql-deployment)!\r\n\r\n## Important Changes\r\n- **Retroactively remove lock permissions** from existing service-broker-created users [[#132881499](https://www.pivotaltracker.com/story/show/132881499)]\r\n  \r\n  One major limitation of Galera is that table-level locks are not replicated. We've found that many applications which rely on table locking never notice this limitation when moving onto cf-mysql. In order to fail fast, starting in [v32](https://github.com/cloudfoundry/cf-mysql-release/releases/tag/v32), new service bindings are explicitly disallowed from locking tables. Starting with v34, all existing service bindings will no longer have the ability to lock tables. Apps that attempt to lock tables will now see an error of the form:\r\n  \r\n  ```\r\n    MariaDB [cf_eedd5768_9c6c_4388_ae0b_dc64f4022bf4]\u003e LOCK TABLES fruit WRITE;\r\n    ERROR 1044 (42000): Access denied for user 'uoY64cqdw6qyMtNl'@'%' to database 'cf_eedd5768_9c6c_4388_ae0b_dc64f4022bf4'\r\n  ```\r\n- Rename broker-deregistrar to **deregister-and-purge-instances** [[#138006305](https://www.pivotaltracker.com/story/show/138006305)]\r\n  \r\n  Too often, Operators have been burned trying out an innocuously-named errand. Renaming the errand, `deregister-and-purge-instances` makes it clear that this is an errand that should only be run just before `bosh delete-deployment`.\r\n\r\n### Dependency Upgrades\r\n\r\ncf-mysql relies on a variety of OSS packages. Part of using cf-mysql is that you always get the latest bits!\r\n- cf-mysql-release should use MariaDB 10.1.20 [[#133906749](https://www.pivotaltracker.com/story/show/133906749)]\r\n- Golang 1.7 upgrade [[#133294695](https://www.pivotaltracker.com/story/show/133294695)]\r\n- Bump cf CLI to v6.22.2 or greater [[#133940783](https://www.pivotaltracker.com/story/show/133940783)]\r\n- Upgrade xtrabackup [[#117744831](https://www.pivotaltracker.com/story/show/117744831)]\r\n\r\n### Tuning and Configuration Improvements\r\n- job spec for previous_admin_username should state that it is optional [[#133758449](https://www.pivotaltracker.com/story/show/133758449)]\r\n- Allow monit startup timeout for mariadb_ctl job to be configurable [[#135742055](https://www.pivotaltracker.com/story/show/135742055)]\r\n  - Remove unused `database_startup_timeout` property from mysql job spec [[#133138729](https://www.pivotaltracker.com/story/show/133138729)]\r\n- As an App Developer, I'd like an exception if trying to store invalid data in the database [[#137836651](https://www.pivotaltracker.com/story/show/137836651)]\r\n- As a Developer, I don't want DDLs and DMLs to be limited by the number of rows they affect [[#137044863](https://www.pivotaltracker.com/story/show/137044863)]\r\n- [BUG] MySQL jobs fail to start if the mysql port is not 3306 [[#136590189](https://www.pivotaltracker.com/story/show/136590189)]\r\n- [BUG] allow `cf-mysql.mysql.binlog_enabled` and `cf-mysql.mysql.innodb_buffer_pool_instances` to be overwritten from property-overrides stub [[#133969391](https://www.pivotaltracker.com/story/show/133969391)]\r\n\r\n### Switchboard Changes\r\n\r\nSimilar to CF's HTTP router, Switchboard can now account for the healthchecks of an upstream load balancer.\r\n- Switchboard delays shutdown till external Load Balancer fails over  [[#137933317](https://www.pivotaltracker.com/story/show/137933317)]\r\n- Switchboard delays startup for a period of time so that a LB can notice and register that it is alive  [[#137933307](https://www.pivotaltracker.com/story/show/137933307)]\r\n- As a CF-MySQL operator, I expect the switchboard proxies to no longer claim a lock in consul when in consul-enabled mode  [[#135490687](https://www.pivotaltracker.com/story/show/135490687)]\r\n\r\n### Bug Fixes\r\n- [BUG] bootstrap errand should use the same property name for galera_healthcheck as other jobs [[#136389887](https://www.pivotaltracker.com/story/show/136389887)]\r\n- [BUG] Interruptor scaretext directs Operator to do the wrong thing [[#137205271](https://www.pivotaltracker.com/story/show/137205271)]\r\n- [BUG] cf-mysql-broker should always stop when asked to stop [[#136631833](https://www.pivotaltracker.com/story/show/136631833)]\r\n- [BUG] mariadb_ctrl fails to start if mysql takes longer than 60 seconds to start [[#137485517](https://www.pivotaltracker.com/story/show/137485517)]\r\n- [BUG] Link error for rejoin-unsafe errand if no arbitrator job [[#138841321](https://www.pivotaltracker.com/story/show/138841321)]\r\n- [BUG] mariadb control should start if there's no prestart marker [[#138540989](https://www.pivotaltracker.com/story/show/138540989)]\r\n\r\n### Miscellaneous Other Improvements\r\n- Reduce the chance of the mysql stalling due to disk filling up from binary logs.  [[#133888125](https://www.pivotaltracker.com/story/show/133888125)]\r\n- broker should log when it fails to run the initial mysql script [[#133232467](https://www.pivotaltracker.com/story/show/133232467)]\r\n\r\n### BOSH 2.0-ification\r\n\r\nAs mentioned in the cf-mysql-release v32 release notes, we're gradually improving in our ability to leverage BOSH 2.0 semantics. This work is now being centralized in [cf-mysql-deployment](https://github.com/cloudfoundry/cf-mysql-deployment).\r\n- Ability to remove broker instances (BOSH 2) [[#133894727](https://www.pivotaltracker.com/story/show/133894727)]\r\n- Ability to enable cert verification (BOSH 2) [[#133894695](https://www.pivotaltracker.com/story/show/133894695)]\r\n- [BUG] Removing broker instances with overrides file should also remove broker related errands [[#134320837](https://www.pivotaltracker.com/story/show/134320837)]\r\n- bosh 2 template should default to not requiring CF [[#136082119](https://www.pivotaltracker.com/story/show/136082119)]\r\n- cloudfoundry/cf-mysql-release #141: simplify bosh template [[#136469529](https://www.pivotaltracker.com/story/show/136469529)]\r\n- As an Operator, I'd like a sample bosh 2.0 override file to help understand how to assign static IPs to the proxy instances [[#136539935](https://www.pivotaltracker.com/story/show/136539935)]\r\n- As an Operator, I'd like instructions that help me translate a spiff generated manifest to a BOSH 2.0 manifest [[#136290983](https://www.pivotaltracker.com/story/show/136290983)]\r\n\r\n### Documentation Updates\r\n- cloudfoundry/cf-mysql-release #139: Update README.md [[#135583739](https://www.pivotaltracker.com/story/show/135583739)]\r\n- [BUG] slow query log is undocumented  [[#138053415](https://www.pivotaltracker.com/story/show/138053415)]\r\n- [BUG] Security Groups documentation mistakenly deleted  [[#138685491](https://www.pivotaltracker.com/story/show/138685491)]\r\n- Update cf-stub [[#137069195](https://www.pivotaltracker.com/story/show/137069195)]\r\n  You haven't needed to use our `cf-stub.yml` file in some time, so we've removed it. Just use a real cf-release deployment manifest.\r\n- **Explore** if Galera 25.3.19 interferes with bootstrap errand or makes the interruptor irrelevant [[#134379769](https://www.pivotaltracker.com/story/show/134379769)]\r\n  Galera now includes its own version of the Interruptor. It takes care of some additional corner cases (such as boostrapping from the wrong node), but doesn't conflict with our own Interruptor. We allow the to coexist. You can disable our Interruptor if it's too disruptive.\r\n\r\n### Community Contributions\r\n\r\nAs an OSS project, we welcome Pull Requests. Sometimes, those pull requests are not directly related to our product direction. So long as they are additive, and don't introduce conflicts, we're happy to include them. Including these features in the release does not imply that we routinely test this functionality - these features are considered, \"community contributed.\" If there are issues with these features, we're happy to consider additional PRs from the community!\r\n- cloudfoundry/cf-mysql-broker #19: Allow any 2.3+ ruby [[#136116997](https://www.pivotaltracker.com/story/show/136116997)]\r\n- cloudfoundry/cf-mysql-release #103: Allow the main mysql host to be specified via config. [[#118524849](https://www.pivotaltracker.com/story/show/118524849)]\r\n- cloudfoundry/cf-mysql-release #137: smoke_tests should specify domain when pushing cf app [[#135204167](https://www.pivotaltracker.com/story/show/135204167)]\r\n- cloudfoundry/cf-mysql-release #108: Default cf_mysql.host to nil [[#121247455](https://www.pivotaltracker.com/story/show/121247455)]\r\n- cloudfoundry/cf-mysql-release #142: enable event scheduler [[#137246355](https://www.pivotaltracker.com/story/show/137246355)]\r\n- cloudfoundry/cf-mysql-release #144: adding properties override in cf-mysql-template.yml [[#137528165](https://www.pivotaltracker.com/story/show/137528165)]\r\n- cloudfoundry/cf-mysql-release #145: Update comments for kill_and_wait() [[#138063011](https://www.pivotaltracker.com/story/show/138063011)]\r\n- cloudfoundry/cf-mysql-release #146: Fix quoting in check_mount() [[#138063035](https://www.pivotaltracker.com/story/show/138063035)]\r\n\r\n## Manifest Changes\r\n\r\nFor those who manually update your manifests, please complete the survey above by clicking a heart!\r\n- `cf_mysql.mysql.healthcheck_port` has been renamed to `cf_mysql.mysql.galera_healthcheck_port`\r\n- `cf_mysql.mysql.galera_healthcheck.endpoint_username`, now defaults to \"galera-healthcheck\"\r\n- `cf_mysql.broker.auth_username` now has a default of admin\r\n- `cf_mysql.mysql.wsrep_max_ws_rows` now defaults to 0, rather than 128K\r\n- `cf_mysql.mysql.binlog_expire_days` defaults to 7 days, not 60\r\n- New: `cf_mysql.mysql.advertise_host`, optional\r\n- New: `cf_mysql.mysql.startup_timeout`, replaces `cf_mysql.mysql.database_startup_timeout`\r\n  Now defaults to 60 seconds (this isn't 100% accurate as they are used in slightly different places resulting in a better experience when it takes a while to start mysql e.g. continual IST)\r\n- New: `cf_mysql.mysql.event_scheduler`, defaults to \"off\"\r\n"
}